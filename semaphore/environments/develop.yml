---
- name: Fetch environments 
  uri:
    method: GET
    validate_certs: no
    return_content: yes
    url: "{{ automation }}/project/{{ semaphore_project_id }}/environment"
    body_format: json
    status_code: 200
    headers:
      Cookie: "semaphore={{ semaphore_token }}"
  ignore_errors: yes 
  register: environments

- name: set develop environment Id 
  set_fact: 
    "env_develop_id": "{{ item.id }}"
  when: 
    - item.name == "Develop"
  with_items: "{{ environments.json }}"

- name: Create develop Environment
  uri:
    method: POST
    validate_certs: no
    return_content: yes
    url: "{{ automation }}/project/{{ semaphore_project_id }}/environment"
    body_format: json
    status_code: 204
    body: '{ "name": "Develop", "project_id": {{ semaphore_project_id }}, "password": "string", "json": "{}"}'
    headers:
      Cookie: "semaphore={{ semaphore_token }}"
  when: 
    - env_develop_id is not defined 

- name: Update develop Environment
  uri:
    method: PUT
    validate_certs: no
    return_content: yes
    url: "{{ automation }}/project/{{ semaphore_project_id }}/environment/{{ env_develop_id }}"
    body_format: json
    status_code: 204
    body: '{ "name": "Develop", "id": {{ env_develop_id }}, "project_id": {{ semaphore_project_id }}, "password": "string", "json": "{}" }'
    headers:
      Cookie: "semaphore={{ semaphore_token }}"
  register: output_env_updated
  when: 
    - env_develop_id is defined 
  
- name: Fetch environments after created the new env
  uri:
    method: GET
    validate_certs: no
    return_content: yes
    url: "{{ automation }}/project/{{ semaphore_project_id }}/environment"
    body_format: json
    status_code: 200
    headers:
      Cookie: "semaphore={{ semaphore_token }}"
  ignore_errors: yes 
  register: environments
  when:
    - env_develop_id is not defined 

- name: set develop environment Id 
  set_fact: 
    "env_develop_id": "{{ item.id }}"
  when: 
    - env_develop_id is not defined 
    - item.name == "Develop"
  with_items: "{{ environments.json }}"